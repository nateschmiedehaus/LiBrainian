name: npm-publish

on:
  workflow_dispatch:
    inputs:
      publish:
        description: Publish to npm after verification
        required: true
        type: boolean
        default: false
      npm_tag:
        description: npm dist-tag to publish under
        required: false
        type: string
        default: latest
      allow_trusted_fallback:
        description: allow trusted publishing fallback when no valid npm token is available
        required: false
        type: boolean
        default: false
  release:
    types:
      - published

permissions:
  contents: read
  id-token: write
  packages: write

concurrency:
  group: npm-publish
  cancel-in-progress: false

jobs:
  verify:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm
          registry-url: https://registry.npmjs.org

      - name: Install dependencies
        run: npm ci

      - name: Typecheck
        run: npm run typecheck

      - name: Package identity guard
        run: npm run package:assert-identity

      - name: Build and pack
        run: npm run release:pack

      - name: Outcome-based E2E diagnostics gate
        id: outcome_gate
        continue-on-error: true
        run: npm run test:e2e:outcome

      - name: Triage outcome diagnoses
        id: outcome_triage
        if: always()
        continue-on-error: true
        run: npm run test:e2e:triage

      - name: Development-truth tarball E2E gate
        id: reality_dev_truth
        continue-on-error: true
        run: npm run test:e2e:dev-truth

      - name: In-repo acceptance E2E gate
        id: acceptance_gate
        continue-on-error: true
        run: npm run test:e2e:acceptance

      - name: Enforce E2E gate outcomes
        if: always()
        run: |
          set -euo pipefail
          failed=0
          if [ "${{ steps.outcome_gate.outcome }}" != "success" ]; then
            echo "::error::Outcome diagnostics gate failed."
            failed=1
          fi
          if [ "${{ steps.outcome_triage.outcome }}" != "success" ]; then
            echo "::error::Outcome triage requires immediate action."
            failed=1
          fi
          if [ "${{ steps.reality_dev_truth.outcome }}" != "success" ]; then
            echo "::error::Development-truth tarball reality gate failed."
            failed=1
          fi
          if [ "${{ steps.acceptance_gate.outcome }}" != "success" ]; then
            echo "::error::Acceptance gate failed."
            failed=1
          fi
          exit "$failed"

      - name: Evidence sync
        run: |
          if [ -f eval-results/ab-results.json ]; then
            npm run evidence:sync
          else
            echo "::notice::Skipping evidence sync (missing eval-results/ab-results.json)."
          fi

      - name: Evidence drift guard
        run: |
          if [ -f state/evidence/evidence-manifest.json ]; then
            npm run evidence:drift-check
          else
            echo "::notice::Skipping evidence drift guard (missing state/evidence/evidence-manifest.json)."
          fi

      - name: Fast release smoke tests
        run: npm test -- --run src/__tests__/package_identity.test.ts src/__tests__/package_release_scripts.test.ts src/__tests__/github_readiness_docs.test.ts

      - name: Upload pre-publish E2E artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: publish-e2e-artifacts
          path: state/e2e/*.json
          if-no-files-found: warn

  publish-release:
    if: github.event_name == 'release'
    needs: verify
    runs-on: ubuntu-latest
    timeout-minutes: 45
    environment: npm-publish
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm
          registry-url: https://registry.npmjs.org

      - name: Trusted publish runtime guard
        run: node scripts/assert-trusted-publish-runtime.mjs

      - name: Install dependencies
        run: npm ci

      - name: Build distributable
        run: npm run package:assert-identity && npm run clean && npm run build && npm run package:install-smoke

      - name: Determine npm auth mode
        id: npm-auth
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}
          ALLOW_TRUSTED_FALLBACK: ${{ vars.LIBRARIAN_ALLOW_TRUSTED_FALLBACK || 'false' }}
        run: |
          set -euo pipefail
          candidate_token="${NPM_TOKEN:-${NODE_AUTH_TOKEN:-}}"
          allow_trusted="$(echo "${ALLOW_TRUSTED_FALLBACK:-false}" | tr '[:upper:]' '[:lower:]')"
          if [ -n "${candidate_token:-}" ]; then
            npmrc="$(mktemp)"
            trap 'rm -f "$npmrc"' EXIT
            printf "//registry.npmjs.org/:_authToken=%s\n" "$candidate_token" > "$npmrc"
            if NPM_CONFIG_USERCONFIG="$npmrc" npm whoami --registry=https://registry.npmjs.org >/dev/null 2>&1; then
              echo "mode=token" >> "$GITHUB_OUTPUT"
            else
              if [ "$allow_trusted" = "true" ]; then
                echo "::warning::Registry token is invalid or revoked; using explicitly-allowed trusted publishing fallback (OIDC)."
                echo "mode=trusted" >> "$GITHUB_OUTPUT"
              else
                echo "::error::No valid npm token detected. Refusing implicit fallback."
                echo "::error::Set a valid NPM_TOKEN/NODE_AUTH_TOKEN secret, or set LIBRARIAN_ALLOW_TRUSTED_FALLBACK=true after configuring npm trusted publishing for this repository."
                exit 1
              fi
            fi
          else
            if [ "$allow_trusted" = "true" ]; then
              echo "::warning::No npm token provided; using explicitly-allowed trusted publishing fallback (OIDC)."
              echo "mode=trusted" >> "$GITHUB_OUTPUT"
            else
              echo "::error::No npm token provided and trusted fallback is disabled."
              echo "::error::Set a valid NPM_TOKEN/NODE_AUTH_TOKEN secret, or set LIBRARIAN_ALLOW_TRUSTED_FALLBACK=true after configuring npm trusted publishing."
              exit 1
            fi
          fi
          if [ "$(cat "$GITHUB_OUTPUT" | tail -n 1)" = "mode=trusted" ] && [ -z "${ACTIONS_ID_TOKEN_REQUEST_URL:-}" ]; then
            echo "::error::Trusted publishing selected but OIDC id-token is unavailable."
            echo "::error::Ensure workflow permissions include id-token: write."
            exit 1
          fi

      - name: Publish to npm (token)
        id: npm-publish-token
        if: steps.npm-auth.outputs.mode == 'token'
        continue-on-error: true
        run: npm publish --provenance --access public --ignore-scripts
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN || secrets.NODE_AUTH_TOKEN }}

      - name: Publish to npm (trusted)
        id: npm-publish-trusted
        if: steps.npm-auth.outputs.mode == 'trusted'
        continue-on-error: true
        run: |
          set +e
          npm publish --provenance --access public --ignore-scripts
          status=$?
          set -e
          if [ "$status" -ne 0 ]; then
            echo "::error::Trusted publishing failed (likely npm trusted publisher not configured for this repo/workflow)."
            echo "::error::Configure npm trusted publishing for package 'librainian' and GitHub workflow 'publish-npm.yml' in npm package settings."
            echo "::error::Or provide a valid NPM_TOKEN/NODE_AUTH_TOKEN secret and rerun."
            exit "$status"
          fi
        env:
          NODE_AUTH_TOKEN: ''
          NPM_TOKEN: ''

      - name: Publish to GitHub Packages
        if: always()
        run: npm run release:github-packages
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
          LIBRARIAN_GH_PACKAGE_REGISTRY: https://npm.pkg.github.com

      - name: Enforce npm publish success
        if: always()
        run: |
          set -euo pipefail
          mode="${{ steps.npm-auth.outputs.mode }}"
          token_outcome="${{ steps.npm-publish-token.outcome }}"
          trusted_outcome="${{ steps.npm-publish-trusted.outcome }}"
          if [ "$mode" = "token" ]; then
            if [ "$token_outcome" != "success" ]; then
              echo "::error::npm publish (token mode) failed."
              exit 1
            fi
            exit 0
          fi
          if [ "$mode" = "trusted" ]; then
            if [ "$trusted_outcome" != "success" ]; then
              echo "::error::npm publish (trusted mode) failed."
              exit 1
            fi
            exit 0
          fi
          echo "::error::Unknown npm auth mode: $mode"
          exit 1

  publish-manual:
    if: github.event_name == 'workflow_dispatch' && inputs.publish == true
    needs: verify
    runs-on: ubuntu-latest
    timeout-minutes: 45
    environment: npm-publish
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm
          registry-url: https://registry.npmjs.org

      - name: Trusted publish runtime guard
        run: node scripts/assert-trusted-publish-runtime.mjs

      - name: Install dependencies
        run: npm ci

      - name: Build distributable
        run: npm run package:assert-identity && npm run clean && npm run build && npm run package:install-smoke

      - name: Determine npm auth mode
        id: npm-auth
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}
          ALLOW_TRUSTED_FALLBACK: ${{ inputs.allow_trusted_fallback && 'true' || (vars.LIBRARIAN_ALLOW_TRUSTED_FALLBACK || 'false') }}
        run: |
          set -euo pipefail
          candidate_token="${NPM_TOKEN:-${NODE_AUTH_TOKEN:-}}"
          allow_trusted="$(echo "${ALLOW_TRUSTED_FALLBACK:-false}" | tr '[:upper:]' '[:lower:]')"
          if [ -n "${candidate_token:-}" ]; then
            npmrc="$(mktemp)"
            trap 'rm -f "$npmrc"' EXIT
            printf "//registry.npmjs.org/:_authToken=%s\n" "$candidate_token" > "$npmrc"
            if NPM_CONFIG_USERCONFIG="$npmrc" npm whoami --registry=https://registry.npmjs.org >/dev/null 2>&1; then
              echo "mode=token" >> "$GITHUB_OUTPUT"
            else
              if [ "$allow_trusted" = "true" ]; then
                echo "::warning::Registry token is invalid or revoked; using explicitly-allowed trusted publishing fallback (OIDC)."
                echo "mode=trusted" >> "$GITHUB_OUTPUT"
              else
                echo "::error::No valid npm token detected. Refusing implicit fallback."
                echo "::error::Set a valid NPM_TOKEN/NODE_AUTH_TOKEN secret, or run workflow_dispatch with allow_trusted_fallback=true after configuring npm trusted publishing."
                exit 1
              fi
            fi
          else
            if [ "$allow_trusted" = "true" ]; then
              echo "::warning::No npm token provided; using explicitly-allowed trusted publishing fallback (OIDC)."
              echo "mode=trusted" >> "$GITHUB_OUTPUT"
            else
              echo "::error::No npm token provided and trusted fallback is disabled."
              echo "::error::Set a valid NPM_TOKEN/NODE_AUTH_TOKEN secret, or re-run with allow_trusted_fallback=true after configuring npm trusted publishing."
              exit 1
            fi
          fi
          if [ "$(cat "$GITHUB_OUTPUT" | tail -n 1)" = "mode=trusted" ] && [ -z "${ACTIONS_ID_TOKEN_REQUEST_URL:-}" ]; then
            echo "::error::Trusted publishing selected but OIDC id-token is unavailable."
            echo "::error::Ensure workflow permissions include id-token: write."
            exit 1
          fi

      - name: Publish to npm (manual token)
        id: npm-publish-token
        if: steps.npm-auth.outputs.mode == 'token'
        continue-on-error: true
        run: npm publish --provenance --access public --ignore-scripts --tag "${NPM_TAG:-latest}"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN || secrets.NODE_AUTH_TOKEN }}
          NPM_TAG: ${{ inputs.npm_tag }}

      - name: Publish to npm (manual trusted)
        id: npm-publish-trusted
        if: steps.npm-auth.outputs.mode == 'trusted'
        continue-on-error: true
        run: |
          set +e
          npm publish --provenance --access public --ignore-scripts --tag "${NPM_TAG:-latest}"
          status=$?
          set -e
          if [ "$status" -ne 0 ]; then
            echo "::error::Trusted publishing failed (likely npm trusted publisher not configured for this repo/workflow)."
            echo "::error::Configure npm trusted publishing for package 'librainian' and GitHub workflow 'publish-npm.yml' in npm package settings."
            echo "::error::Or provide a valid NPM_TOKEN/NODE_AUTH_TOKEN secret and rerun."
            exit "$status"
          fi
        env:
          NODE_AUTH_TOKEN: ''
          NPM_TOKEN: ''
          NPM_TAG: ${{ inputs.npm_tag }}

      - name: Publish to GitHub Packages (manual)
        if: always()
        run: npm run release:github-packages
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
          LIBRARIAN_GH_PACKAGE_REGISTRY: https://npm.pkg.github.com
          NPM_TAG: ${{ inputs.npm_tag }}

      - name: Enforce npm publish success (manual)
        if: always()
        run: |
          set -euo pipefail
          mode="${{ steps.npm-auth.outputs.mode }}"
          token_outcome="${{ steps.npm-publish-token.outcome }}"
          trusted_outcome="${{ steps.npm-publish-trusted.outcome }}"
          if [ "$mode" = "token" ]; then
            if [ "$token_outcome" != "success" ]; then
              echo "::error::npm publish (manual token mode) failed."
              exit 1
            fi
            exit 0
          fi
          if [ "$mode" = "trusted" ]; then
            if [ "$trusted_outcome" != "success" ]; then
              echo "::error::npm publish (manual trusted mode) failed."
              exit 1
            fi
            exit 0
          fi
          echo "::error::Unknown npm auth mode: $mode"
          exit 1
